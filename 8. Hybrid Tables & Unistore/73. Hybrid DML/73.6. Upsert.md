# What is an Upsert and How Does it Work in Database Operations

> [!Note]
> An upsert is a database operation that inserts a new record if it doesn't exist, or updates an existing record if it does, combining the functionality of insert and update operations into one.

## Why This Matters
- Understanding upserts supports decisions on how to manage data consistency and integrity in databases.
- Misunderstanding upserts can lead to data duplication, inconsistencies, or loss, which can break applications or cost significant time to rectify.
- You would look up information on upserts when designing database schemas, developing data integration workflows, or troubleshooting data-related issues in real-life applications.

> [!Tip]
> When dealing with uncertain data existence, try using upsert operations to ensure data consistency and avoid errors related to duplicate or missing records.

## Key Points
- An upsert operation checks for the existence of a record based on a unique identifier.
- If the record exists, the upsert operation updates the existing record with new data.
- If the record does not exist, the upsert operation creates a new record.
- Upserts can be performed using SQL merge statements, insert on duplicate key update, or through application logic.
- The choice of upsert method depends on the database management system being used and the specific requirements of the application.

> [!important]
> The primary key or unique identifier of the record must be correctly defined and matched during an upsert operation to avoid creating duplicate records or updating the wrong record.

## Mental Model
1. **Check Existence**: Determine if a record with a given unique identifier already exists in the database.
2. **Insert or Update**: Based on the existence check, either insert a new record or update the existing one with the provided data.
3. **Confirm Outcome**: Verify that the operation has resulted in the expected state, whether a new record was inserted or an existing record was updated.

## Observe
- A common mistake people make is not properly handling the case where multiple concurrent upsert operations attempt to insert or update the same record, leading to potential data inconsistencies.
- A silent failure mode can occur if the upsert operation fails due to a database constraint violation, but the error is not properly caught or handled, resulting in unexpected application behavior.
- A misleading assumption is that upserts are always atomic operations; however, their atomicity can depend on the database system and the specific implementation of the upsert.

> [!Important]
> Consider a scenario where an e-commerce application needs to update a customer's address. If the customer record exists, the address should be updated; if not, a new customer record should be created. An upsert operation ensures that the customer's data is handled correctly in both cases, maintaining data integrity and consistency.