# 11.8. Stored Procs

Canonical documentation for [11.8. Stored Procs](2. Data Engineering & Pipelines/11. Snowpark & Developer/11.8. Stored Procs.md). This document defines concepts, terminology, and standard usage.

## Purpose
Stored procedures exist to provide a mechanism for encapsulating procedural logic directly within a data management system. By storing executable code on the server side, they address the need for reduced network latency, centralized business logic enforcement, and enhanced security through abstraction. They allow complex operations involving multiple data manipulations to be executed as a single unit of work, often improving performance through pre-optimization and reuse of execution plans.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the architectural role of stored procedures rather than specific syntax.

## Scope
The scope of this document covers the theoretical and functional framework of stored procedures as a component of database architecture.

> [!IMPORTANT]
> **In scope:**
> * Core functionality: Encapsulation, parameterization, and execution context.
> * Theoretical boundaries: The relationship between the application layer and the data layer.
> * Security and performance implications of server-side logic.

> [!WARNING]
> **Out of scope:**
> * Specific vendor implementations (e.g., T-SQL, PL/SQL, PL/pgSQL).
> * Syntax-specific debugging or optimization techniques.
> * Comparison of specific database engine performance metrics.

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| Stored Procedure | A collection of procedural statements stored in the database catalog that can be invoked by name. |
| Parameter | A named variable used to pass data into or receive data out of a procedure. |
| Execution Plan | The internal roadmap generated by the database engine to execute the procedure's logic efficiently. |
| Side Effect | A change to the state of the database (e.g., UPDATE, INSERT, DELETE) resulting from procedure execution. |
| Determinism | The property where a procedure consistently produces the same output given the same input and state. |

## Core Concepts
Stored procedures represent the intersection of declarative data querying and procedural programming.

**Encapsulation and Abstraction**
Stored procedures act as an API for the database. By exposing a procedure instead of raw tables, the underlying schema can change without breaking the calling application, provided the procedure interface remains constant.

**Execution Context and Security**
Procedures often execute with different permissions than the user calling them (often referred to as "owner's rights" vs. "caller's rights"). This allows users to perform complex operations on data they cannot access directly.

**Performance Optimization**
Because procedures are stored on the server, the engine can pre-parse and optimize the logic. This reduces the overhead of sending large blocks of code over the network and allows the engine to reuse cached execution plans.

> [!TIP]
> Think of a stored procedure as a "Macro" for your database; instead of sending ten separate instructions over a slow network, you send one command to trigger a high-speed local script.

## Standard Model
The standard model for a stored procedure follows a defined lifecycle:

1.  **Definition:** The logic is written using a procedural language and submitted to the database.
2.  **Compilation/Validation:** The database engine checks for syntax errors and object existence.
3.  **Persistence:** The procedure is stored in the system catalog.
4.  **Invocation:** A client or another process calls the procedure by name, passing required parameters.
5.  **Execution:** The engine retrieves the optimized plan and executes the procedural logic, returning results or status codes.

The model assumes a request-response pattern where the procedure may return result sets, output parameters, or a simple return code indicating success or failure.

## Common Patterns
*   **Data Access Layer (DAL) Encapsulation:** All CRUD (Create, Read, Update, Delete) operations are routed through procedures to ensure data integrity.
*   **Batch Processing:** Handling large-scale data transformations or maintenance tasks locally on the server to avoid network bottlenecks.
*   **Complex Validation:** Enforcing business rules that require checking multiple tables or state conditions before allowing a write operation.
*   **Transaction Management:** Wrapping multiple operations in a single transaction within the procedure to ensure atomicity.

## Anti-Patterns
*   **The "God" Procedure:** Creating a single, massive procedure that handles too many unrelated tasks, making maintenance difficult.
*   **Business Logic Leakage:** Placing logic in the database that belongs in the application layer (e.g., UI formatting or external service orchestration).
*   **Over-reliance on Dynamic SQL:** Building query strings inside a procedure, which can bypass the benefits of pre-compilation and introduce security risks.

> [!CAUTION]
> Avoid circular dependencies where Procedure A calls Procedure B, which in turn calls Procedure A. This leads to stack exhaustion and unpredictable system state.

## Edge Cases
*   **Recursive Execution:** Some systems allow procedures to call themselves. This requires careful management of depth limits to prevent memory exhaustion.
*   **Temporary Object Scope:** Procedures creating temporary tables may behave differently depending on whether the table persists for the session or only the procedure's duration.
*   **Implicit Commits:** In some environments, certain procedural commands might trigger an implicit transaction commit, potentially breaking the atomicity of the calling process.
*   **Version Mismatch:** When a procedure is updated while an active session is still using a cached version of the previous execution plan.

## Related Topics
*   **Triggers:** Automated procedures invoked by data modification events.
*   **User-Defined Functions (UDFs):** Similar to procedures but typically restricted to returning values without side effects.
*   **ACID Compliance:** The set of properties (Atomicity, Consistency, Isolation, Durability) that procedures often help enforce.
*   **Execution Plan Caching:** The mechanism by which the database stores optimized paths for procedure execution.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-02-17 | Initial AI-generated canonical documentation |