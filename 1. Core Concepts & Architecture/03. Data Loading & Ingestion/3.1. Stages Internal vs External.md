# What are Internal and External Stages in Data Platforms?

> [!Information]
> Internal stages are managed storage within a data platform, ideal for transient data, while external stages utilize independent object storage for scalable, persistent data operations.

## Why This Matters
-   **Decision Support**: Choosing the optimal staging location for data ingestion, transformation, and extraction pipelines, directly influencing data pipeline performance, operational costs, data security posture, and compliance with data governance policies.
-   **Consequences of Misunderstanding**: Suboptimal data loading and unloading performance, leading to increased processing times; unexpected and potentially high storage or data transfer costs; non-compliance with data residency or retention policies; and critical security vulnerabilities arising from misconfigured access controls or data exposure.
-   **Real-life Lookup**: When architecting new data ingestion or extraction pipelines, diagnosing data load or unload failures, performing cost optimization for data storage and transfer, or implementing secure data sharing and exchange with external applications or partners.

## Key Points
-   **Platform-Managed Storage**: Data resides within the data platform's proprietary storage infrastructure, offering seamless integration with the platform's compute resources and native security features.
-   **Independent Object Storage**: Data is stored in external, cloud-native object storage services (e.g., AWS S3, Azure Blob Storage, Google Cloud Storage), providing virtually limitless scalability, often lower storage costs, and architectural decoupling from the data platform.
-   **Transient Data Lifecycle**: Data in internal stages is generally considered ephemeral, intended for temporary staging during data ingestion or extraction. It is often automatically purged after a set period or requires explicit manual cleanup, making it unsuitable for long-term archival.
-   **Persistent Data Lifecycle**: External stages are ideal for persistent data storage, serving as a data lake for raw or semi-processed data, long-term archival, or as a central hub for data sharing across diverse applications, platforms, and organizational boundaries.
-   **Integrated Security vs. Delegated Security**: Access to internal stages is controlled by the data platform's native Identity and Access Management (IAM) system. Access to external stages requires configuring secure authentication mechanisms (e.g., IAM roles, storage access keys, service principals) that delegate permissions from the data platform to the external object storage service.
-   **Platform-Specific vs. Object Storage Pricing**: Internal stages incur costs based on the data platform's specific storage pricing tiers, often bundled with compute. External stages follow the object storage provider's pricing model, which typically includes costs for storage capacity, data transfer (egress/ingress), and API operations (e.g., PUT, GET, LIST requests).
-   **Data Format Flexibility**: Internal stages often have implicit or explicit expectations about data formats for optimal performance. External stages offer greater flexibility, supporting a wide array of file formats (e.g., Parquet, ORC, CSV, JSON) and schema evolution, making them suitable for diverse data lake architectures.
-   **Access Patterns**: Internal stages are primarily accessed by the data platform itself for load/unload operations. External stages can be directly accessed by other applications, services, or users outside the data platform, enabling broader data consumption and integration.

> [!important]
> The fundamental distinction lies in who manages the storage and the intended persistence and accessibility of the staged data.

## Mental Model
-   **Data Ingestion**:
    1.  **Source Data Generation**: Raw data files are produced by source systems.
    2.  **Stage Selection**: Determine whether to use an **Internal Stage** (for transient, platform-managed storage) or an **External Stage** (for persistent, independently managed object storage).
    3.  **Data Staging**: Files are securely uploaded or placed into the chosen staging location.
    4.  **Data Loading**: The data platform initiates a command to read the staged files and load their contents into a target table within the platform.
-   **Data Extraction**:
    1.  **Source Table Identification**: Data resides in a specific table or view within the data platform.
    2.  **Stage Selection**: Determine whether to use an **Internal Stage** or an **External Stage** for the unloaded data.
    3.  **Data Unloading**: The data platform executes a command to write data from the source table into files, placing them into the selected stage.
    4.  **File Retrieval/Consumption**: The generated files are then retrieved from the stage for external consumption, archival, or integration with other systems.

## Gotchas
-   **Unintended Data Loss from Internal Stages**: Assuming data placed in an internal stage will persist indefinitely. Internal stages are often designed for transient use, with data subject to automatic purging policies or requiring manual cleanup, leading to unexpected data loss if not promptly processed or moved.
-   **Surprise Egress Costs**: Underestimating or overlooking data transfer (egress) costs, especially when moving large volumes of data from an external stage in one cloud region to a data platform in a different region, or when data is accessed frequently by services outside the object storage's network.
-   **Complex Permission Management for External Stages**: Misconfiguring IAM roles, access keys, or service principals required for the data platform to interact with external object storage. This often results in cryptic "Access Denied" errors during load/unload operations, which can be challenging to troubleshoot due to the distributed nature of permissions.
-   **Performance Degradation due to Data Locality**: Staging data in an external object storage bucket that is geographically distant from the data platform's compute resources. This introduces significant network latency, severely impacting data load and unload performance and increasing processing times.
-   **Lack of Versioning in Internal Stages**: Relying on internal stages for data versioning or historical snapshots. Internal stages typically do not offer built-in versioning capabilities, making it difficult to recover previous states of data if overwritten or corrupted.
-   **Exposing Credentials for External Stages**: Hardcoding or embedding sensitive access credentials (e.g., API keys) directly within scripts or configurations for external stages, rather than utilizing secure IAM roles or temporary credentials, creating a significant security vulnerability.

> [!Tip]
> A data engineering team needs to ingest daily log files. For small, daily batches that are immediately processed and then discarded, an **internal stage** offers simplicity and speed. However, if the logs are massive, need to be retained for compliance, and shared with a separate machine learning pipeline, an **external stage** in an object storage bucket is the more scalable and cost-effective solution.